<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
      window.__PUBLIC_PATH = "/";
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/index.ts"></script>
    <script>
      window.MwdHelpers = {
        // Converts a file/folder path into query parameters for navigation
        fileItemQueryParams: (item) => {
          const segs = (item?.path || '').split(':');
          const drive = segs.length === 4
            ? `:${segs.slice(1, 3).join(':')}:`
            : item?.drive || '';
          const path = segs.length === 4
            ? segs.slice(3).join(':')
            : item?.path || '';

          if (item?.isFolder) {
            return { drive, folder: path };
          }

          const parts = path.split('/');
          return {
            drive,
            folder: parts.slice(0, -1).join('/'),
            file: parts[parts.length - 1]
          };
        },

        // Get parent folder path (one level up)
        getParentFolder: (folder) => {
          if (!folder) return null;
          // Remove trailing slashes and find parent folder
          const normalized = folder.replace(/\/+$/g, '');
          const lastSlash = normalized.lastIndexOf('/');
          return lastSlash > 0 ? normalized.substring(0, lastSlash) : '/';
        },

        // Build navigation URL for a folder path
        buildNavigationUrl: (folderPath) => {
          const queryParams = MwdHelpers.fileItemQueryParams({
            path: folderPath,
            isFolder: true
          });

          const queryString = Object.entries(queryParams || {})
            .filter(([key, value]) => value)
            .map(([key, value]) =>
              `${encodeURIComponent(key)}=${encodeURIComponent(value)}`
            )
            .join('&');

          return queryString ? `/my-files?${queryString}` : '/my-files';
        },

        // --- Get the file extension from the full file path
        getFileExtension: (filePath) =>
          filePath?.includes(".")
            ? filePath?.split(".").pop()?.toLowerCase()
            : undefined,

        // --- Get the file/folder name from the full path
        getFileName: (filePath) => {
          if (!filePath) return '';
          const normalized = filePath.replace(/\/+$/g, '');
          const lastSlash = normalized.lastIndexOf('/');
          return lastSlash >= 0 ? normalized.substring(lastSlash + 1) : normalized;
        },

        // --- Get the object property by path (e.g. "a.b[0].c")
        getPropertyByPath: (object, path) => {
          if (!object || typeof object !== "object") {
            return undefined;
          }

          if (!path || typeof path !== "string") {
            return undefined;
          }

          const pathArray = path
            .replace(/\[(\d+)\]/g, ".$1")
            .split(".")
            .filter(Boolean);

          let result = object;

          for (const key of pathArray) {
            if (result == null || typeof result !== "object") {
              return undefined;
            }
            result = result[key];
          }

          return result;
        },

        sortFiles: (files, sortBy, direction) => {
          if (!files) return [];
          if (sortBy === undefined) return files.slice();
          const sorted = files.slice().toSorted((a, b) => {
            const compMin = direction === "ascending" ? -1 : 1;
            const compMax = direction === "ascending" ? 1 : -1;

            if (sortBy === "type") {
              const _a = MwdHelpers.getFileExtension(a.name) || "";
              const _b = MwdHelpers.getFileExtension(b.name) || "";
              return _a > _b ? compMax : _b > _a ? compMin : 0;
            } else {
              return MwdHelpers.getPropertyByPath(a, sortBy) >
                MwdHelpers.getPropertyByPath(b, sortBy)
                ? compMax
                : MwdHelpers.getPropertyByPath(b, sortBy) >
                  MwdHelpers.getPropertyByPath(a, sortBy)
                ? compMin
                : 0;
            }
          });
          return sorted;
        },
      };

      // Global event bus using window.postMessage
      // Source: https://docs.xmlui.org/components/MessageListener
      window.publishTopic = (type, payload) => {
        window.postMessage({ type, payload }, '*');
      };
    </script>
  </body>
</html>
